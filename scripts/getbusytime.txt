Sub getbusytime()
   Dim meetingroom() As String
   Dim address_name As String
   Dim max_meetingroom As Integer, num_meetingroom As Integer, max_num_meettime As Integer, num_meetingtime As Integer
   Dim span As Integer, start_point As Integer, splittime_r As Integer
   Dim start_time As Double, end_time As Double, splittime As Double
   Dim meetingday As Double, getfreetime As Date
   Dim imtr As Integer, imtc As Integer, imrr As Integer, imrc As Integer
   Dim busytime_array() As String
   '会議室が存在するか（有効なアドレス or 名前か）チェック
   '空行チェック
   '現在より過去の指定ではないか

   '会議室の最大数を指定
   max_meetingroom = 20
   ReDim meetingroom(max_meetingroom)
   ReDim busytime_array(max_meetingroom, 2)
   '会議を設定したい日時の最大数を指定
   max_num_meetingtime = 20

   '会議時間の最小単位（15分であるため、シリアル値は1/24/4
   splittime_r = 15
   splittime = 1 / 24 / (60 / splittime_r)

   '初期化
   num_meetingroom = 0

   '空き時間取得したい時間の左上セル(日付列)
   init_meetingtime_point = "B6"
   '会議室一覧の最初のセル(会議室名列)
   init_meetingroom_point = "K6"

   imtr = Range(init_meetingtime_point).Row - 1
   imtc = Range(init_meetingtime_point).Column

   imrr = Range(init_meetingroom_point).Row - 1
   imrc = Range(init_meetingroom_point).Column

   '空き時間を取得したい会議室の一覧を配列に格納
   For i = 1 To max_meetingroom
      If Len(Cells(i + imrr, imrc).Value) > 3 Then
     num_meetingroom = num_meetingroom + 1
     meetingroom(num_meetingroom) = Cells(i + imrr, imrc).Value
      End If
   Next i


   '空き時間を取得したい日時を取得し、各日時ごとにループ
   For i = 1 To max_num_meetingtime
      '有効な入力情報のみ評価
      If (Len(Cells(i + imtr, imtc).Value) > 0) And (VarType(Cells(i + imtr, imtc).Value) = 7) Then
     meetingday = Cells(i + imtr, imtc).Value
     flag = 0
     '優先順位の高い会議室から空き情報のチェック
     For j = 1 To num_meetingroom
        '空き時間情報取得に失敗した会議室はスキップする
        If busytime_array(j, 2) = "NG" Then
           GoTo CONTINUE
        End If

        start_time = Cells(i + imtr, imtc + 2).Value
        end_time = Cells(i + imtr, imtc + 3).Value
        span = (end_time - start_time) / splittime
        start_point = start_time / splittime
        getbusytime_flag = 1
        '空き情報を取得している日付であれば空き時間情報結果を再利用
        If Len(busytime_array(j, 1)) > 0 Then
           If (meetingday - CDate(busytime_array(j, 1))) <= 0 And (meetingday - CDate(busytime_array(j, 1))) <= 30 Then
             getbusytime_flag = 0
           End If
        End If

        '空き時間情報を再利用できない場合、Outlook経由で空き時間情報を取得
        If Not (getbusytime_flag = 0) Then

           busytime_array(j, 2) = mock_busydata(address_name, CDate(meetingday), splittime_r)
           If busytime_array(j, 2) = "NG" Then
             MsgBox (meetingroom(j) & "の空き時間情報取得に失敗しました")
           End If

           busytime_array(j, 1) = meetingday

        End If

        Debug.Print busytime_array(j, 1)
        Debug.Print busytime_array(j, 2)

        '取得していた空き時間情報で判定
        If (determine_freetime(busytime_array(j, 2), Val(busytime_array(j, 1)), meetingday, start_point, span, splittime_r) = 0) Then
           '空いていた場合、Forループを抜ける
           Debug.Print "OK"
           Debug.Print j
           Exit For
        End If

CONTINUE:

     Next j

     'どこも空いていない場合
     If flag = 0 Then
        Cells(i + imtr, imtc + 5).Value = "空きなし"
     Else
        Cells(i + imtr, imtc + 5).Value = meetingroom(j)
     End If

      End If

   Next i

End Sub

Private Function determine_freetime(busytime_string As String, busytime_day As Double, freeday As Double, start_point As Integer, span As Integer, splittime_r As Integer) As Integer

   Dim result As Integer, count As Integer
   Dim diffday As Integer
   Dim busytime_day_string As String

   result = 1
   diffday = freeday - busytime_day
   count = 0

   '30日分の空き時間情報から指定日の情報を切り出す
   For i = 1 To Len(busytime_string) Step (24 * (60 / splittime_r))
      If count = diffday Then

     busytime_day_string = Mid(busytime_string, i, (24 * (60 / splittime_r)))
     Exit For

      End If
   Next i

   If Mid(busytime_day_string, start_point, span) = String(span, "1") Then
      result = 0

   End If

   determine_freetime = result

End Function

Private Function get_busydata(address_name As String, busydate As Date, split_time As Integer) As String
    Set objOutlook = CreateObject("Outlook.Application")
    Set objNameSpace = objOutlook.GetNamespace("MAPI")

    Set objRecipient = objNameSpace.CreateRecipient(address_name)

    If objRecipient Is Nothing Then
       strFreeBusyData = "NG"
    Else
       strFreeBusyData = objRecipient.FreeBusy(busydate, split_time)
    End If

End Function
